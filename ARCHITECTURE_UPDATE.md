# Обновление архитектуры: Переход на Яндекс.Диск

## Что изменилось

### До обновления
- Треки загружались на сервер и сохранялись в базе данных
- Файлы хранились в таблице `media_files` как base64
- Компонент `AudioUploader` загружал файлы через `/backend/file-upload`
- Плеер получал файлы из базы данных через `apiClient.loadMediaFile()`

### После обновления
- Треки хранятся на Яндекс.Диске пользователя
- В базе данных сохраняются **только ссылки** на файлы
- Компонент `AudioUploader` **больше не используется**
- Плеер воспроизводит треки через **прокси-сервер** (`/backend/yandex-proxy`)
- Прокси обходит CORS-ограничения Яндекс.Диска
- Ссылки **кешируются на 30 минут** для быстрого доступа

## Технические изменения

### 1. Новая утилита для работы с Яндекс.Диском
**Файл**: `src/utils/yandexDisk.ts`

Функции:
- `convertYandexDiskUrl(publicUrl)` - конвертирует публичную ссылку в прокси-ссылку для плеера
- `isYandexDiskUrl(url)` - проверяет, является ли URL ссылкой на Яндекс.Диск
- `clearUrlCache()` - очищает кеш прокси-ссылок
- `getCacheStats()` - получает статистику использования кеша

**Кеширование**: Прокси-ссылки кешируются на 30 минут для оптимизации производительности. Автоматическая очистка устаревших записей происходит при превышении 50 записей в кеше.

**React хук**: `src/hooks/useYandexDiskCache.ts` для управления кешем в компонентах

### 2. Обновленные формы добавления треков
**Файлы**: 
- `src/components/TrackForm.tsx`
- `src/components/AlbumForm.tsx`

Изменения:
- Удалён компонент `AudioUploader`
- Добавлены инструкции по загрузке на Яндекс.Диск
- Поля для ввода ссылок вместо загрузки файлов

### 3. Обновленный плеер
**Файл**: `src/components/MusicPlayer.tsx`

Изменения:
- Добавлен импорт `convertYandexDiskUrl`
- Удалён код загрузки файлов из БД (`apiClient.loadMediaFile`)
- Теперь все ссылки автоматически конвертируются для воспроизведения

### 4. Обновленная утилита музыкального API
**Файл**: `src/utils/musicApi.ts`

Изменения:
- Функция `getTrackFile()` теперь конвертирует ссылки Яндекс.Диска
- Удалена зависимость от `apiClient` для загрузки файлов

### 5. Обновленный компонент AudioPlayer
**Файл**: `src/components/artist/AudioPlayer.tsx`

Изменения:
- Добавлена конвертация ссылок при загрузке треков

## База данных

### Структура не изменилась
Поле `file` в таблице `tracks` продолжает хранить строку, но теперь это:
- **Раньше**: ID файла в формате `audio_xxxxx`
- **Теперь**: URL-ссылка на Яндекс.Диск (например, `https://disk.yandex.ru/d/...`)

## Backend функции

### Функции БЕЗ изменений
- `/backend/music-api` - продолжает работать как раньше
- `/backend/user-music` - продолжает сохранять и читать треки
- `/backend/auth` - авторизация без изменений

### Функции БОЛЬШЕ НЕ ИСПОЛЬЗУЮТСЯ
- `/backend/file-upload` - можно удалить или оставить для обратной совместимости

## Преимущества новой архитектуры

✅ **Меньше нагрузки на сервер** - файлы не загружаются на хостинг  
✅ **Меньше использования БД** - в базе только ссылки, а не гигабайты аудио  
✅ **Неограниченное хранилище** - зависит только от Яндекс.Диска пользователя  
✅ **Высокая скорость** - CDN Яндекса быстрее загружает файлы  
✅ **Простота управления** - пользователь управляет файлами на своём Диске  

## Как это работает

```
1. Пользователь загружает трек на Яндекс.Диск
2. Получает публичную ссылку (https://disk.yandex.ru/d/...)
3. Вставляет ссылку в форму на сайте
4. Ссылка сохраняется в БД в поле tracks.file
5. При воспроизведении:
   - MusicPlayer получает ссылку из tracks.file
   - convertYandexDiskUrl() проверяет кеш (30 мин)
   - Если в кеше - возвращает прокси-ссылку мгновенно
   - Если нет - создаёт прокси-ссылку и сохраняет в кеш
   - Плеер запрашивает файл через прокси-сервер
   - Прокси получает файл с Яндекс.Диска и передаёт плееру
```

### Прокси-сервер
**Backend функция**: `/backend/yandex-proxy`

**Зачем нужен прокси?**
- Обходит CORS-ограничения Яндекс.Диска
- Поддерживает потоковое воспроизведение (Range requests)
- Добавляет правильные заголовки для браузерного плеера
- Кеширует результаты для оптимизации

## Обратная совместимость

Старые треки (с ID `audio_xxxxx` в поле `file`) больше **не будут воспроизводиться**.

Если нужно сохранить старые треки:
1. Экспортировать их из таблицы `media_files`
2. Загрузить на Яндекс.Диск
3. Обновить ссылки в таблице `tracks`

## Миграция данных (опционально)

Если есть старые треки в БД, создайте миграцию для очистки неиспользуемых данных:

```sql
-- Удаление старых аудиофайлов из media_files
DELETE FROM t_p39135821_musician_site_projec.media_files 
WHERE file_type LIKE 'audio/%';

-- Обновление треков с устаревшими ссылками (опционально - установить NULL)
UPDATE t_p39135821_musician_site_projec.tracks 
SET file = NULL 
WHERE file LIKE 'audio_%';
```

## Файлы для удаления (опционально)

Если вы уверены, что старая система загрузки больше не нужна:
- `src/components/AudioUploader.tsx`
- `backend/file-upload/` (вся директория)
- Таблица `media_files` в БД (после миграции данных)

## Поддержка

Для пользователей создана инструкция: `YANDEX_DISK_GUIDE.md`